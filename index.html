<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discador WM</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{--gold:#b08540;--gold-dark:#a06e2d;--bg:#f8f4ef;--text:#333;--gray:#d1d5db;--green:#25d366;--danger:#d9534f;--danger-dark:#c13d3a;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh}
    header{background:var(--gold);color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .logo{display:flex;align-items:center;font-size:1.4rem;font-weight:600}
    .logo img{height:50px;margin-right:12px}
    .top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;font-weight:bold;gap:8px;flex-wrap:wrap}
    main{flex:1;padding:24px;max-width:1100px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .top{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    input[type=file],input[type=text],textarea{width:100%;padding:8px;border:1px solid var(--gray);border-radius:6px}
    textarea{resize:vertical}
    button{background:var(--gold);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
    button:hover{background:var(--gold-dark)}
    .btn-danger{background:var(--danger)} .btn-danger:hover{background:var(--danger-dark)}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem}
    th,td{border:1px solid var(--gray);padding:6px;text-align:left}
    th{background:var(--bg)}
    .badge{padding:2px 6px;border-radius:4px;color:#fff;font-size:.75rem;font-weight:600}
    .novo{background:#6b7280} .ligado{background:#ef4444} .whats{background:var(--green)}
    .quente{background:#c2410c} .frio{background:#64748b}
    .info-expanded{font-weight:bold;background:#f3f4f6}
    footer{margin:24px auto 8px;font-size:.8rem;color:#666;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="logo.png" alt="WM">WM Assessoria</div>
    <div>
      <button id="fileResetBtn" class="btn-danger">Limpar Planilha</button>
      <button id="backupBtn">Backup (JSON)</button>
      <button id="reportBtn">Relatório (Excel)</button>
    </div>
  </header>
  <div class="top-bar">
    <span><img src="https://cdn-icons-png.flaticon.com/512/5973/5973800.png" width="20"> Ligações feitas hoje: <span id="callCount">0</span></span>
  </div>
  <main>
    <div class="top">
      <input type="file" id="fileInput" accept=".csv,.xlsx">
      <input type="text" id="search" placeholder="Buscar nome ou número">
    </div>
    <textarea id="msgTemplate" rows="3">Olá ${firstName}, tudo bem? Aqui é o William da Direcional!</textarea>
    <table>
      <thead>
        <tr><th>Nome</th><th>Número</th><th>Status</th><th>Lead</th><th>Resultado</th><th>Info</th><th>Ações</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>
  <footer>© 2025 WM Assessoria</footer>
  <script>
    let contacts = JSON.parse(localStorage.getItem('wm_contacts')||'[]');
    let calls = 0;
    const tbody=document.getElementById('tbody'),search=document.getElementById('search'),callEl=document.getElementById('callCount'),tpl=document.getElementById('msgTemplate');
    const save=()=>localStorage.setItem('wm_contacts',JSON.stringify(contacts));
    const formatTel=num=>{const raw=num.replace(/\D/g,'');return (raw.startsWith('19')||raw.startsWith('0'))?raw:'0'+raw;};
    function render(f=''){tbody.innerHTML='';const norm=s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      contacts.filter(c=>norm(c.nome).includes(norm(f))||c.numero.includes(f)).forEach((c,i)=>{
        tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${c.nome}</td>
          <td>${c.numero}</td>
          <td><span class="badge ${c.status}">${c.status}</span></td>
          <td><select onchange="setLead(${i},this.value)"><option></option>
            <option value="quente" ${c.lead==='quente'?'selected':''}>quente</option>
            <option value="frio" ${c.lead==='frio'?'selected':''}>frio</option></select></td>
          <td><select onchange="setRes(${i},this.value)"><option></option>
            <option value="atendeu" ${c.result==='atendeu'?'selected':''}>atendeu</option>
            <option value="caixa" ${c.result==='caixa'?'selected':''}>caixa</option>
            <option value="desligou" ${c.result==='desligou'?'selected':''}>desligou</option></select></td>
          <td><input id="info-${i}" value="${c.info||''}" oninput="setInfo(${i},this.value)"
                     class="${c.expanded?'info-expanded':''}">
              <button class="save-btn" id="save-${i}" onclick="saveRow(${i})">Salvar</button></td>
          <td><button onclick="call(${i})">Ligar</button>
              <button style="background:var(--green);" onclick="whats(${i})">Whats</button></td>
        </tr>`);});}
    const setLead=(i,v)=>{contacts[i].lead=v;save();};
    const setRes =(i,v)=>{contacts[i].result=v;save();};
    const setInfo=(i,v)=>{contacts[i].info=v;document.getElementById('save-'+i).style.display='inline-block';
                          document.getElementById('info-'+i).classList.add('info-expanded');};
    function call(i){window.open('tel:'+formatTel(contacts[i].numero),'_self');contacts[i].status='ligado';calls++;callEl.textContent=calls;
                     contacts[i].expanded=true;save();render(search.value);}
    function saveRow(i){contacts[i].expanded=false;contacts.push(contacts.splice(i,1)[0]);save();render(search.value);}
    function whats(i){const c=contacts[i];const msg=tpl.value.replace('${firstName}',c.nome.split(' ')[0]);
      window.open(`https://wa.me/55${c.numero.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`,'_blank');
      navigator.clipboard.writeText(msg);contacts[i].status='whats';save();render(search.value);}
    fileInput.onchange=e=>{const f=e.target.files[0];if(!f)return;const ext=f.name.split('.').pop().toLowerCase();
      const map=r=>({nome:(r.nome||r.Nome||r.contato||'').trim(),numero:String(r.numero||r.Numero||r.telefone||'').replace(/\D/g,''),status:'novo',lead:'',result:'',info:'',expanded:false});
      const merge=list=>{const set=new Set(contacts.map(c=>c.numero));list.forEach(c=>{if(c.numero&&c.nome&&!set.has(c.numero)){contacts.push(c);set.add(c.numero);} });save();render(search.value);};
      if(ext==='csv')Papa.parse(f,{header:true,skipEmptyLines:true,complete:r=>merge(r.data.map(map))});
      else if(['xlsx','xls'].includes(ext)){const rd=new FileReader();rd.onload=x=>{const wb=XLSX.read(x.target.result,{type:'binary'});
        merge(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).map(map));};rd.readAsBinaryString(f);}else alert('Formato não suportado');};
    backupBtn.onclick=()=>{const blob=new Blob([JSON.stringify(contacts,null,2)],{type:'application/json'});
      Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'backup_discador.json'}).click();};
    reportBtn.onclick=()=>{const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(contacts);
      XLSX.utils.book_append_sheet(wb,ws,'Relatorio');
      const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});const toBuf=s=>{const buf=new ArrayBuffer(s.length);
        const view=new Uint8Array(buf);for(let i=0;i<s.length;i++)view[i]=s.charCodeAt(i)&0xFF;return buf;};
      const blob=new Blob([toBuf(wbout)],{type:'application/octet-stream'});
      Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'relatorio_discador.xlsx'}).click();};
    fileResetBtn.onclick=()=>{if(!confirm('Tem certeza que deseja limpar?'))return;
      contacts=[];calls=0;callEl.textContent='0';save();render();};
    search.oninput=()=>render(search.value);
    if(!contacts.length)contacts=[{nome:'Exemplo',numero:'19999999999',status:'novo'}];render();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discador WM</title>

  <!-- PWA / ícones (opcional) -->
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Bibliotecas para ler CSV / XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <!-- ================= ESTILO ================= -->
  <style>
    :root{
      --gold:#b08540;--gold-dark:#a06e2d;--bg:#f8f4ef;--text:#333;
      --gray:#d1d5db;--green:#25d366;--danger:#d9534f;--danger-dark:#c13d3a;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);
         display:flex;flex-direction:column;min-height:100vh;}

    header{background:var(--gold);color:#fff;padding:12px 20px;display:flex;
           justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
    .logo{display:flex;align-items:center;font-size:1.4rem;font-weight:600;}
    .logo img{height:52px;margin-right:12px;}

    .top-bar{display:flex;justify-content:space-between;align-items:center;
             padding:12px 20px;font-weight:bold;gap:8px;flex-wrap:wrap;}
    .top-bar img{width:20px;margin-right:8px;}

    main{flex:1;padding:24px;max-width:1100px;margin:auto;background:#fff;
         border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);}

    .top{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;}
    input[type=file],input[type=text],textarea{
      padding:8px;border:1px solid var(--gray);border-radius:6px;width:100%;}
    textarea{resize:vertical;}

    button{background:var(--gold);color:#fff;border:none;padding:8px 14px;
           border-radius:6px;cursor:pointer;}
    button:hover{background:var(--gold-dark);}
    .btn-danger{background:var(--danger);} .btn-danger:hover{background:var(--danger-dark);}
    .save-btn{background:#4ade80;margin-left:6px;display:none;}

    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem;}
    th,td{border:1px solid var(--gray);padding:6px;text-align:left;}
    th{background:var(--bg);}

    .badge{padding:2px 6px;border-radius:4px;color:#fff;font-size:.75rem;font-weight:600;}
    .novo{background:#6b7280;} .ligado{background:#ef4444;} .whats{background:var(--green);} .quente{background:#c2410c;} .frio{background:#64748b;}

    .info-expanded{font-weight:bold;background:#f3f4f6;}
    footer{margin:24px auto 8px;font-size:.8rem;color:#666;text-align:center;}
  </style>
</head>
<body>
  <!-- ---------- Cabeçalho ---------- -->
  <header>
    <div class="logo"><img src="logo.png" alt="WM logo">WM Assessoria</div>
    <div>
      <button id="fileResetBtn" class="btn-danger">Limpar Planilha</button>
      <button id="backupBtn">Backup (JSON)</button>
      <button id="reportBtn">Relatório (Excel)</button>
    </div>
  </header>

  <!-- ---------- Contador ---------- -->
  <div class="top-bar">
    <span>
      <img src="https://cdn-icons-png.flaticon.com/512/5973/5973800.png">
      Ligações feitas hoje: <span id="callCount">0</span>
    </span>
  </div>

  <!-- ---------- Conteúdo ---------- -->
  <main>
    <div class="top">
      <input type="file" id="fileInput" accept=".csv,.xlsx">
      <input type="text" id="search" placeholder="Buscar nome ou número">
    </div>

    <textarea id="msgTemplate" rows="3">Olá ${firstName}, tudo bem? Aqui é o William da Direcional!</textarea>

    <table>
      <thead>
        <tr>
          <th>Nome</th><th>Número</th><th>Status</th><th>Lead</th>
          <th>Resultado</th><th>Info</th><th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>

  <footer>© 2025 WM Assessoria</footer>

  <!-- ================= SCRIPT ================= -->
  <script>
    /* ===== Estado ===== */
    let contacts = JSON.parse(localStorage.getItem('wm_contacts') || '[]');
    let calls    = 0;

    /* ===== Elementos ===== */
    const tbody  = document.getElementById('tbody');
    const search = document.getElementById('search');
    const callEl = document.getElementById('callCount');
    const tpl    = document.getElementById('msgTemplate');

    /* ===== Helpers ===== */
    const save = () => localStorage.setItem('wm_contacts', JSON.stringify(contacts));

    // Adiciona 0 em qualquer DDD diferente de 19 (e que ainda não tenha 0)
    const formatTel = num => {
      const raw = num.replace(/\D/g,'');
      if (raw.startsWith('19') || raw.startsWith('0')) return raw;
      return '0' + raw;
    };

    /* ===== Renderização ===== */
    function render(filtro='') {
      tbody.innerHTML = '';
      const norm = s => s.toLowerCase()
                         .normalize('NFD')
                         .replace(/[\u0300-\u036f]/g,'');
      contacts.filter(c =>
          norm(c.nome).includes(norm(filtro)) ||
          c.numero.includes(filtro)
        ).forEach((c,i) => {
          tbody.insertAdjacentHTML('beforeend',`
            <tr id="row-${i}">
              <td>${c.nome}</td>
              <td>${c.numero}</td>
              <td><span class="badge ${c.status}">${c.status}</span></td>
              <td>
                <select onchange="setLead(${i},this.value)">
                  <option value=""></option>
                  <option value="quente" ${c.lead==='quente'?'selected':''}>quente</option>
                  <option value="frio"   ${c.lead==='frio'  ?'selected':''}>frio</option>
                </select>
              </td>
              <td>
                <select onchange="setRes(${i},this.value)">
                  <option value=""></option>
                  <option value="atendeu"  ${c.result==='atendeu' ?'selected':''}>atendeu</option>
                  <option value="caixa"    ${c.result==='caixa'   ?'selected':''}>caixa</option>
                  <option value="desligou" ${c.result==='desligou'?'selected':''}>desligou</option>
                </select>
              </td>
              <td>
                <input id="info-${i}" value="${c.info||''}"
                       oninput="setInfo(${i},this.value)"
                       class="${c.expanded?'info-expanded':''}">
                <button class="save-btn" id="save-${i}" onclick="saveRow(${i})">Salvar</button>
              </td>
              <td>
                <button onclick="call(${i})">Ligar</button>
                <button style="background:var(--green);" onclick="whats(${i})">Whats</button>
              </td>
            </tr>
          `);
        });
    }

    /* ===== Mutations ===== */
    const setLead = (i,v)=>{ contacts[i].lead   = v; save(); };
    const setRes  = (i,v)=>{ contacts[i].result = v; save(); };
    const setInfo = (i,v)=>{
      contacts[i].info = v;
      document.getElementById('save-'+i).style.display='inline-block';
      document

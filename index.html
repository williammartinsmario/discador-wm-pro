<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wm Discador</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Poppins',sans-serif;
    background:#f4f6f9;
    color:#333;
    padding-bottom:80px;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 32px;background:#fff;border-bottom:2px solid #e5e7eb;
  }
  .logo-box{display:flex;align-items:center;gap:16px}
  .logo-box img{height:60px}
  header h1{font-size:26px;color:#003366;font-weight:600}
  #top-bar{
    display:flex;flex-wrap:wrap;align-items:center;gap:12px;
    padding:16px 32px;background:#fafafa;border-bottom:1px solid #ddd;
  }
  button{
    display:inline-flex;align-items:center;gap:6px;
    padding:10px 18px;border:none;border-radius:8px;font-weight:600;
    font-size:14px;cursor:pointer;transition:.25s;white-space:nowrap;
  }
  button:hover{opacity:.9;transform:translateY(-2px)}
  .btn-ligar{background:#dc3545;color:#fff}
  .btn-whats{background:#25D366;color:#fff}
  .btn-salvar{background:#ff9800;color:#fff}
  .btn-backup{background:#007bff;color:#fff}
  .btn-reset{background:#6c757d;color:#fff}
  .btn-acoes{background:#f1f3f5;color:#333}
  input[type="text"],select{
    padding:9px 12px;border:1px solid #ccc;border-radius:8px;font-size:14px
  }
  #contador{padding:16px 32px;font-weight:600;color:#444}
  .contato-card{
    background:#fff;margin:16px 32px;border-radius:10px;
    box-shadow:0 1px 4px rgba(0,0,0,.08);padding:18px 22px
  }
  .contato-top{
    display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:10px
  }
  .contato-top span.nome{font-weight:600;min-width:230px}
  .contato-top span.numero{color:#555}
  .formulario{margin-top:10px;display:grid;gap:8px}
  .formulario select,.formulario textarea{border:1px solid #ccc;border-radius:8px;font-size:14px;padding:8px}
  textarea{min-height:60px;resize:vertical}
  h2.section{margin:32px 32px 8px;font-size:22px;color:#003366}
  table{width:calc(100% - 64px);margin:0 32px 32px;border-collapse:collapse}
  thead{background:#003366;color:#fff}
  th,td{padding:10px;border:1px solid #d1d5db;font-size:14px;text-align:left}
  tbody tr:nth-child(even){background:#f9fafb}
  footer{
    position:fixed;bottom:0;width:100%;padding:14px;
    background:#003366;color:#fff;text-align:center;font-size:13px
  }
  </style>
</head>
<body>

<header>
  <div class="logo-box">
    <img src="logo.png" alt="WM Logo">
    <h1>Wm Discador</h1>
  </div>
  <button class="btn-reset" onclick="resetGeral()">üîÑ Reset Geral</button>
</header>

<div id="top-bar">
  <input type="file" id="fileInput" accept=".csv">
  <input type="text" id="dddPadrao" placeholder="DDD padr√£o (ex: 62)" maxlength="2" inputmode="numeric">
  <textarea id="textoContatos" rows="2" placeholder="Cole aqui: Nome,Numero" style="min-width:260px"></textarea>
  <button class="btn-acoes" onclick="importarTexto()">üì• Adicionar colagem</button>
  <input type="text" id="filtroNome" placeholder="üîç Filtrar nome">
  <select id="filtroLead">
    <option value="">Todos os leads</option>
    <option value="Quente">üî• Quente</option>
    <option value="Frio">‚ùÑÔ∏è Frio</option>
    <option value="Aguardando">‚è≥ Aguardando</option>
  </select>
  <button class="btn-acoes" onclick="limparFiltros()">üßπ Limpar Filtros</button>
  <button class="btn-backup" onclick="exportarPendentes()">üíæ Backup pendentes</button>
  <button class="btn-backup" onclick="exportarCSV()">üíæ Backup hist√≥rico</button>
</div>

<p id="contador">üìä Liga√ß√µes feitas hoje: 0</p>
<div id="lista-contatos"></div>

<h2 class="section">üìú Hist√≥rico de Liga√ß√µes</h2>
<table id="contatos-feitos">
  <thead><tr><th>Nome</th><th>N√∫mero</th><th>Status</th><th>Informa√ß√µes</th><th>Lead</th><th>Data/Hora</th></tr></thead>
  <tbody></tbody>
</table>

<footer>¬© 2025 WM Assessoria ‚Äì Todos os direitos reservados.</footer>

<script>
let contatos=[];let contatosFeitos=[];let db;const HISTORICO_LOCAL_KEY="contatosFeitos";const DB_NAME="DiscadorDB";const DB_VERSION=2;
const DDD_STORAGE_KEY="dddPadrao";
document.getElementById("fileInput").addEventListener("change",importarCSV);
document.getElementById("filtroNome").addEventListener("input",renderizarContatos);
document.getElementById("filtroLead").addEventListener("change",renderizarContatos);
document.getElementById("dddPadrao").addEventListener("input",e=>{
  const ddd=e.target.value.replace(/\D/g,"").slice(0,2);
  definirDDDPadrao(ddd);
});

function normalizarNumero(numeroEntrada,dddPreferido){
  let numero=numeroEntrada.replace(/\D/g,"");
  let dddUsado=dddPreferido||"";

  if(numero.startsWith("55")&&numero.length>=12){
    numero=numero.slice(2);
  }

  if(numero.length>=10){
    dddUsado=numero.slice(0,2);
    let celular=numero.slice(2);
    if(celular.length===8){
      celular="9"+celular;
    }
    numero=dddUsado+celular;
  }else if(dddUsado&&numero.length>=8){
    let celular=numero;
    if(celular.length===8){
      celular="9"+celular;
    }
    numero=dddUsado+celular;
  }else if(numero.length<10){
    numero="";
  }

  return{numero,dddUsado};
}

function obterDDDPadrao(){
  const input=document.getElementById("dddPadrao");
  const armazenado=localStorage.getItem(DDD_STORAGE_KEY)||"";
  const ddd=(input.value||armazenado||"").replace(/\D/g,"").slice(0,2);
  return ddd;
}

function definirDDDPadrao(ddd){
  const limpo=ddd.replace(/\D/g,"").slice(0,2);
  localStorage.setItem(DDD_STORAGE_KEY,limpo);
  const input=document.getElementById("dddPadrao");
  if(input.value!==limpo)input.value=limpo;
  return limpo;
}

function abrirBanco(){
  return new Promise((resolve,reject)=>{
    const request=indexedDB.open(DB_NAME,DB_VERSION);

    request.onupgradeneeded=e=>{
      const database=e.target.result;
      if(!database.objectStoreNames.contains("contatos")){
        const store=database.createObjectStore("contatos",{keyPath:"numero"});
        store.createIndex("numero","numero",{unique:true});
      }
      if(!database.objectStoreNames.contains("historico")){
        database.createObjectStore("historico",{keyPath:"id",autoIncrement:true});
      }
    };

    request.onsuccess=e=>{db=e.target.result;resolve(db);};
    request.onerror=()=>reject(request.error||new Error("Erro ao abrir banco"));
  });
}

function aguardarTransacao(tx){
  return new Promise((resolve,reject)=>{
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
    tx.onabort=()=>reject(tx.error);
  });
}

async function carregarContatosPendentes(){
  if(!db)return[];
  return new Promise((resolve,reject)=>{
    const tx=db.transaction("contatos","readonly");
    const store=tx.objectStore("contatos");
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}

async function substituirContatosPendentes(lista){
  if(!db)return;
  const tx=db.transaction("contatos","readwrite");
  const store=tx.objectStore("contatos");
  store.clear();
  lista.forEach(c=>store.put(c));
  return aguardarTransacao(tx);
}

async function removerContatoPendente(numero){
  if(!db)return;
  const tx=db.transaction("contatos","readwrite");
  tx.objectStore("contatos").delete(numero);
  return aguardarTransacao(tx);
}

async function carregarHistorico(){
  if(!db)return[];
  return new Promise((resolve,reject)=>{
    const tx=db.transaction("historico","readonly");
    const store=tx.objectStore("historico");
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}

async function salvarHistorico(registro){
  if(!db)return;
  const tx=db.transaction("historico","readwrite");
  tx.objectStore("historico").add(registro);
  return aguardarTransacao(tx);
}

async function sobrescreverHistorico(lista){
  if(!db)return;
  const tx=db.transaction("historico","readwrite");
  const store=tx.objectStore("historico");
  store.clear();
  lista.forEach(item=>store.put(item));
  return aguardarTransacao(tx);
}

async function limparBanco(){
  if(!db)return;
  const tx=db.transaction(["contatos","historico"],"readwrite");
  tx.objectStore("contatos").clear();
  tx.objectStore("historico").clear();
  return aguardarTransacao(tx);
}

function atualizarLocalHistorico(){
  localStorage.setItem(HISTORICO_LOCAL_KEY,JSON.stringify(contatosFeitos));
}

async function importarCSV(e){
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=async ev=>{
    let dddPadrao=obterDDDPadrao();
    if(!dddPadrao){
      const informado=(prompt("Digite o DDD padr√£o para n√∫meros sem DDD:")||"").trim();
      dddPadrao=definirDDDPadrao(informado);
    }
    let dddDetectado=dddPadrao;

    const linhas=ev.target.result.split(/\r?\n/).slice(1);
    let adicionados=0;let ignorados=0;let duplicados=0;

    linhas.forEach(l=>{
      if(!l.trim())return;
      const[nome,numeroRaw]=l.split(",");
      const {numero,dddUsado}=normalizarNumero(numeroRaw?.trim()||"",dddDetectado);
      if(!numero){ignorados++;return;}
      if(dddUsado&&!dddDetectado)dddDetectado=dddUsado;
      if(contatos.some(c=>c.numero===numero)){duplicados++;return;}
      contatos.push({nome:(nome||"Sem nome").trim()||"Sem nome",numero,lead:"Aguardando"});
      adicionados++;
    });

    if(dddDetectado&&!dddPadrao){
      definirDDDPadrao(dddDetectado);
    }

    await substituirContatosPendentes(contatos);
    renderizarContatos();
    atualizarContador();
    alert(`Importa√ß√£o conclu√≠da: ${adicionados} adicionados, ${duplicados} duplicados ignorados, ${ignorados} inv√°lidos.`);
  };
  r.readAsText(f);
}

async function importarTexto(){
  let dddPadrao=obterDDDPadrao();
  if(!dddPadrao){
    const informado=(prompt("Digite o DDD padr√£o para n√∫meros sem DDD:")||"").trim();
    dddPadrao=definirDDDPadrao(informado);
  }
  let dddDetectado=dddPadrao;

  const texto=document.getElementById("textoContatos").value||"";
  const linhas=texto.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let adicionados=0;let ignorados=0;let duplicados=0;

  linhas.forEach(linha=>{
    const partes=linha.split(",");
    const nome=partes.length>1?partes[0].trim():"";
    const numeroRaw=partes.length>1?partes.slice(1).join(",").trim():partes[0].trim();
    const {numero,dddUsado}=normalizarNumero(numeroRaw,dddDetectado);
    if(!numero){ignorados++;return;}
    if(dddUsado&&!dddDetectado)dddDetectado=dddUsado;
    if(contatos.some(c=>c.numero===numero)){duplicados++;return;}
    contatos.push({nome:nome||"Sem nome",numero,lead:"Aguardando"});
    adicionados++;
  });

  if(!adicionados)return alert("Nenhum contato v√°lido encontrado.");
  await substituirContatosPendentes(contatos);
  renderizarContatos();
  atualizarContador();

  if(dddDetectado&&!dddPadrao){
    definirDDDPadrao(dddDetectado);
  }

  alert(`Importa√ß√£o conclu√≠da: ${adicionados} adicionados, ${duplicados} duplicados ignorados, ${ignorados} inv√°lidos.`);
}

function renderizarContatos(){
  const lista=document.getElementById("lista-contatos");
  lista.innerHTML="";
  const filNome=document.getElementById("filtroNome").value.toLowerCase();
  const filLead=document.getElementById("filtroLead").value;

  contatos.forEach((c,idx)=>{
    if(filNome&&!c.nome.toLowerCase().includes(filNome))return;
    if(filLead&&c.lead!==filLead)return;

    const card=document.createElement("div");
    card.className="contato-card";

    const top=document.createElement("div");
    top.className="contato-top";
    const spanNome=document.createElement("span");
    spanNome.className="nome";
    spanNome.textContent=c.nome;
    const spanNumero=document.createElement("span");
    spanNumero.className="numero";
    spanNumero.textContent=c.numero;
    top.append(spanNome,spanNumero);

    const ligar=criarBtn("üìû Ligar","btn-ligar",()=>window.location.href=`tel:+55${c.numero}`);
    const whats=criarBtn("üí¨ WhatsApp","btn-whats",()=>window.open(`https://wa.me/55${c.numero}`,"_blank"));
    top.append(ligar,whats);

    card.appendChild(top);

    const form=document.createElement("div");
    form.className="formulario";
    const status=select(["Atendeu","Caixa","N√£o Atendeu","Desligou","Sem Resposta"]);
    const info=document.createElement("textarea");
    info.placeholder="Informa√ß√µes adicionais";
    const lead=select(["Quente","Frio","Aguardando"]);
    lead.value=c.lead||"Aguardando";
    const salvar=criarBtn("üíæ Salvar","btn-salvar",async()=>{
      if(!confirm("Salvar no hist√≥rico?"))return;
      const dataHora=new Date().toLocaleString();
      const registro={nome:c.nome,numero:c.numero,status:status.value,info:info.value,lead:lead.value,dataHora};
      contatosFeitos.push(registro);
      atualizarLocalHistorico();
      await salvarHistorico(registro);
      const indiceAtual=contatos.findIndex(item=>item.numero===c.numero);
      if(indiceAtual>=0)contatos.splice(indiceAtual,1);
      await substituirContatosPendentes(contatos);
      renderizarContatos();
      atualizarContatosFeitos();
      atualizarContador();
    });

    form.append(status,info,lead,salvar);
    card.appendChild(form);
    lista.appendChild(card);
  });
}

function criarBtn(txt,cls,fn){
  const b=document.createElement("button");
  b.textContent=txt;
  b.className=cls;
  b.onclick=fn;
  return b;
}

function select(opts){
  const s=document.createElement("select");
  opts.forEach(o=>{
    const op=document.createElement("option");
    op.text=o;op.value=o;
    s.appendChild(op);
  });
  return s;
}

function atualizarContatosFeitos(){
  const tb=document.querySelector("#contatos-feitos tbody");
  tb.innerHTML="";
  contatosFeitos.forEach(c=>{
    const tr=document.createElement("tr");
    const campos=[c.nome,c.numero,c.status,c.info,c.lead,c.dataHora];
    campos.forEach(valor=>{
      const td=document.createElement("td");
      td.textContent=valor;
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

function exportarCSV(){
  const csv="Nome,N√∫mero,Status,Informa√ß√µes,Lead,DataHora\n"+contatosFeitos.map(c=>[c.nome,c.numero,c.status,c.info,c.lead,c.dataHora].join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="contatos_feitos.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportarPendentes(){
  const csv="Nome,N√∫mero,Lead\n"+contatos.map(c=>[c.nome,c.numero,c.lead||"Aguardando"].join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="contatos_pendentes.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

function atualizarContador(){
  const d=new Date().toLocaleDateString();
  const total=contatosFeitos.filter(c=>c.dataHora.startsWith(d)).length;
  document.getElementById("contador").textContent="üìä Liga√ß√µes feitas hoje: "+total;
}

function limparFiltros(){
  document.getElementById("filtroNome").value="";
  document.getElementById("filtroLead").value="";
  renderizarContatos();
}

async function resetGeral(){
  if(confirm("Apagar lista e hist√≥rico?")){
    contatos=[];contatosFeitos=[];
    atualizarLocalHistorico();
    document.getElementById("lista-contatos").innerHTML="";
    await limparBanco();
    atualizarContatosFeitos();
    atualizarContador();
    localStorage.removeItem(HISTORICO_LOCAL_KEY);
    localStorage.removeItem(DDD_STORAGE_KEY);
  }
}

async function inicializarApp(){
  try{
    const dddSalvo=localStorage.getItem(DDD_STORAGE_KEY)||"";
    definirDDDPadrao(dddSalvo||"62");
    await abrirBanco();
    contatos=await carregarContatosPendentes();
    contatosFeitos=await carregarHistorico();

    if(!contatosFeitos.length){
      const local=JSON.parse(localStorage.getItem(HISTORICO_LOCAL_KEY))||[];
      if(local.length){
        contatosFeitos=local;
        await sobrescreverHistorico(local);
      }
    }else{
      atualizarLocalHistorico();
    }

    renderizarContatos();
    atualizarContatosFeitos();
    atualizarContador();
  }catch(err){
    console.error("Erro ao inicializar banco IndexedDB",err);
    contatosFeitos=JSON.parse(localStorage.getItem(HISTORICO_LOCAL_KEY))||[];
    atualizarContatosFeitos();
    atualizarContador();
  }
}

inicializarApp();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wm Discador</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6f9;
      color: #333;
      padding-bottom: 80px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      background: #fff;
      border-bottom: 2px solid #e5e7eb;
    }

    .logo-box {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-box img { height: 60px; }

    header h1 {
      font-size: 26px;
      color: #003366;
      font-weight: 600;
    }

    #top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      padding: 16px 32px;
      background: #fafafa;
      border-bottom: 1px solid #ddd;
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: .25s;
      white-space: nowrap;
    }

    button:hover { opacity: .9; transform: translateY(-2px); }

    .btn-ligar { background: #dc3545; color: #fff; }
    .btn-whats { background: #25D366; color: #fff; }
    .btn-salvar { background: #ff9800; color: #fff; }
    .btn-backup { background: #007bff; color: #fff; }
    .btn-download { background: #0d9488; color: #fff; }
    .btn-reset { background: #6c757d; color: #fff; }
    .btn-acoes { background: #f1f3f5; color: #333; }

    input[type="text"], select {
      padding: 9px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    #resumos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      padding: 16px 32px 0;
    }

    .resumo-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px 18px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .06);
    }

    .resumo-card small { color: #555; }
    .resumo-card strong { display: block; font-size: 22px; margin-top: 6px; color: #003366; }

    #contador {
      padding: 12px 32px 8px;
      font-weight: 600;
      color: #444;
    }

    .contato-card {
      background: #fff;
      margin: 16px 32px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .08);
      padding: 18px 22px;
    }

    .contato-top {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .contato-top span.nome { font-weight: 600; min-width: 230px; }
    .contato-top span.numero { color: #555; }

    .formulario { margin-top: 10px; display: grid; gap: 8px; }

    .formulario select, .formulario textarea {
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      padding: 8px;
    }

    textarea { min-height: 60px; resize: vertical; }

    h2.section {
      margin: 32px 32px 8px;
      font-size: 22px;
      color: #003366;
    }

    table {
      width: calc(100% - 64px);
      margin: 0 32px 32px;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .08);
    }

    thead { background: #003366; color: #fff; }
    th, td { padding: 10px; border: 1px solid #d1d5db; font-size: 14px; text-align: left; }
    tbody tr:nth-child(even) { background: #f9fafb; }

    .estado {
      margin: 16px 32px;
      padding: 14px 16px;
      background: #fff3cd;
      color: #7a5b00;
      border: 1px solid #ffeeba;
      border-radius: 8px;
    }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 14px;
      background: #003366;
      color: #fff;
      text-align: center;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-box">
      <img src="logo.png" alt="WM Logo">
      <h1>Wm Discador</h1>
    </div>
    <button class="btn-reset" onclick="resetGeral()">üîÑ Reset Geral</button>
  </header>

  <div id="top-bar">
    <input type="file" id="fileInput" accept=".csv">
    <input type="text" id="filtroNome" placeholder="üîç Filtrar nome">
    <select id="filtroLead">
      <option value="">Todos os leads</option>
      <option value="Quente">üî• Quente</option>
      <option value="Frio">‚ùÑÔ∏è Frio</option>
      <option value="Aguardando">‚è≥ Aguardando</option>
    </select>
    <select id="filtroStatus">
      <option value="">Todos os status</option>
      <option value="Atendeu">Atendeu</option>
      <option value="Caixa">Caixa</option>
      <option value="N√£o Atendeu">N√£o Atendeu</option>
      <option value="Desligou">Desligou</option>
      <option value="Sem Resposta">Sem Resposta</option>
    </select>
    <button class="btn-acoes" onclick="limparFiltros()">üßπ Limpar Filtros</button>
    <button class="btn-backup" onclick="exportarCSV()">üíæ Backup</button>
    <button class="btn-download" onclick="baixarIndexAtualizado()">‚¨áÔ∏è Baixar index</button>
  </div>

  <div id="resumos">
    <div class="resumo-card">
      <small>Pendentes para discar</small>
      <strong id="pendentes-total">0</strong>
    </div>
    <div class="resumo-card">
      <small>Liga√ß√µes feitas hoje</small>
      <strong id="contador-dia">0</strong>
    </div>
    <div class="resumo-card">
      <small>Total no hist√≥rico</small>
      <strong id="contador-historico">0</strong>
    </div>
  </div>
  <p id="contador">üìä Acompanhe suas liga√ß√µes em tempo real.</p>

  <div id="lista-contatos"></div>

  <h2 class="section">üìú Hist√≥rico de Liga√ß√µes</h2>
  <table id="contatos-feitos">
    <thead>
      <tr>
        <th>Nome</th>
        <th>N√∫mero</th>
        <th>Status</th>
        <th>Informa√ß√µes</th>
        <th>Lead</th>
        <th>Data/Hora</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>¬© 2025 WM Assessoria ‚Äì Todos os direitos reservados.</footer>

  <script>
    const STORAGE_PENDENTES = "wm_contatosPendentes";
    const STORAGE_FEITOS = "contatosFeitos";

    let contatos = carregarPendentes();
    let contatosFeitos = JSON.parse(localStorage.getItem(STORAGE_FEITOS)) || [];

    document.getElementById("fileInput").addEventListener("change", importarCSV);
    document.getElementById("filtroNome").addEventListener("input", renderizarContatos);
    document.getElementById("filtroLead").addEventListener("change", aplicarFiltrosGlobais);
    document.getElementById("filtroStatus").addEventListener("change", aplicarFiltrosGlobais);

    function importarCSV(evento) {
      const arquivo = evento.target.files[0];
      if (!arquivo) return;

      const leitor = new FileReader();
      leitor.onload = (ev) => {
        const linhas = ev.target.result.split(/\r?\n/).slice(1);
        const contatosImportados = linhas
          .map((linha) => {
            const [nome, numeroRaw] = linha.split(",");
            let numero = numeroRaw?.trim() || "";

            numero = numero.replace(/\D/g, "");

            if (numero.length >= 10) {
              const ddd = numero.slice(0, 2);
              let celular = numero.slice(2);
              if (celular.length === 8) {
                celular = "9" + celular;
              }
              numero = ddd + celular;
            }

            return { nome: nome?.trim(), numero };
          })
          .filter((c) => c.nome && c.numero.length >= 10);

        const existentes = new Set(contatos.map((c) => c.numero));
        contatosImportados.forEach((contato) => {
          if (!existentes.has(contato.numero)) {
            contatos.push({ ...contato, lead: "Aguardando" });
          }
        });

        salvarPendentes();
        renderizarContatos();
        atualizarVisoes();
      };
      leitor.readAsText(arquivo);
    }

    function carregarPendentes() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_PENDENTES)) || [];
      } catch (erro) {
        console.warn("N√£o foi poss√≠vel carregar contatos pendentes.", erro);
        return [];
      }
    }

    function salvarPendentes() {
      localStorage.setItem(STORAGE_PENDENTES, JSON.stringify(contatos));
    }

    function renderizarContatos() {
      const lista = document.getElementById("lista-contatos");
      lista.innerHTML = "";
      const filtros = obterFiltros();

      const contatosFiltrados = contatos.filter((contato) => {
        if (filtros.nome && !contato.nome.toLowerCase().includes(filtros.nome)) return false;
        if (filtros.lead && contato.lead !== filtros.lead) return false;
        return true;
      });

      if (!contatosFiltrados.length) {
        lista.innerHTML = '<p class="estado">Nenhum contato pendente no momento. Importe um CSV ou revise os filtros aplicados.</p>';
        return;
      }

      contatosFiltrados.forEach((contato, indice) => {
        const card = document.createElement("div");
        card.className = "contato-card";

        const topo = document.createElement("div");
        topo.className = "contato-top";
        topo.innerHTML = `<span class="nome">${contato.nome}</span><span class="numero">${contato.numero}</span>`;

        const botaoLigar = criarBtn("üìû Ligar", "btn-ligar", () => window.location.href = `tel:+55${contato.numero}`);
        const botaoWhats = criarBtn("üí¨ WhatsApp", "btn-whats", () => window.open(`https://wa.me/55${contato.numero}`, "_blank"));
        topo.append(botaoLigar, botaoWhats);

        card.appendChild(topo);

        const formulario = document.createElement("div");
        formulario.className = "formulario";
        const status = select(["Atendeu", "Caixa", "N√£o Atendeu", "Desligou", "Sem Resposta"], contato.status || "Atendeu");
        const info = document.createElement("textarea");
        info.placeholder = "Informa√ß√µes adicionais";
        info.value = contato.info || "";
        const lead = select(["Quente", "Frio", "Aguardando"], contato.lead || "Aguardando");
        const salvar = criarBtn("üíæ Salvar", "btn-salvar", () => {
          if (!confirm("Salvar no hist√≥rico?")) return;
          const dataHora = new Date().toLocaleString();
          const registro = { nome: contato.nome, numero: contato.numero, status: status.value, info: info.value, lead: lead.value, dataHora };
          contatosFeitos.push(registro);
          localStorage.setItem(STORAGE_FEITOS, JSON.stringify(contatosFeitos));
          contatos.splice(indice, 1);
          salvarPendentes();
          atualizarContatosFeitos();
          renderizarContatos();
          atualizarVisoes();
        });

        formulario.append(status, info, lead, salvar);
        card.appendChild(formulario);
        lista.appendChild(card);
      });
    }

    function criarBtn(texto, classe, acao) {
      const botao = document.createElement("button");
      botao.textContent = texto;
      botao.className = classe;
      botao.onclick = acao;
      return botao;
    }

    function select(opcoes, valorPadrao) {
      const selectElement = document.createElement("select");
      opcoes.forEach((opcao) => {
        const option = document.createElement("option");
        option.text = opcao;
        option.value = opcao;
        selectElement.appendChild(option);
      });
      selectElement.value = valorPadrao;
      return selectElement;
    }

    function atualizarContatosFeitos() {
      const corpo = document.querySelector("#contatos-feitos tbody");
      corpo.innerHTML = "";
      const filtros = obterFiltros();

      const contatosFiltrados = contatosFeitos.filter((contato) => {
        if (filtros.nome && !contato.nome.toLowerCase().includes(filtros.nome)) return false;
        if (filtros.lead && contato.lead !== filtros.lead) return false;
        if (filtros.status && contato.status !== filtros.status) return false;
        return true;
      });

      contatosFiltrados.forEach((contato) => {
        const linha = document.createElement("tr");
        linha.innerHTML = `<td>${contato.nome}</td><td>${contato.numero}</td><td>${contato.status}</td><td>${contato.info}</td><td>${contato.lead}</td><td>${contato.dataHora}</td>`;
        corpo.appendChild(linha);
      });
    }

    function obterFiltros() {
      return {
        nome: document.getElementById("filtroNome").value.toLowerCase(),
        lead: document.getElementById("filtroLead").value,
        status: document.getElementById("filtroStatus").value,
      };
    }

    function exportarCSV() {
      const cabecalho = "Nome,N√∫mero,Status,Informa√ß√µes,Lead,DataHora\n";
      const csv = cabecalho + contatosFeitos
        .map((c) => [c.nome, c.numero, c.status, c.info?.replace(/\n/g, " "), c.lead, c.dataHora].join(","))
        .join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "contatos_feitos.csv";
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function baixarIndexAtualizado() {
      const dados = { pendentes: contatos, feitos: contatosFeitos };
      const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(dados))));
      const scriptBootstrap = `
        <script>
          (function() {
            try {
              const bruto = '${base64}';
              const restaurado = JSON.parse(decodeURIComponent(escape(atob(bruto))));
              localStorage.setItem('${STORAGE_PENDENTES}', JSON.stringify(restaurado.pendentes || []));
              localStorage.setItem('${STORAGE_FEITOS}', JSON.stringify(restaurado.feitos || []));
            } catch (erro) {
              console.warn('N√£o foi poss√≠vel preparar os dados salvos para o download.', erro);
            }
          })();
        <\/script>`;

      const htmlCompleto = document.documentElement.outerHTML.replace("</body>", `${scriptBootstrap}</body>`);

      const blob = new Blob([htmlCompleto], { type: "text/html" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "index-atualizado.html";
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function atualizarVisoes() {
      atualizarContador();
      atualizarResumos();
    }

    function atualizarContador() {
      const dataAtual = new Date().toLocaleDateString();
      const totalHoje = contatosFeitos.filter((c) => c.dataHora.startsWith(dataAtual)).length;
      document.getElementById("contador").textContent = `üìä Liga√ß√µes feitas hoje: ${totalHoje}`;
    }

    function atualizarResumos() {
      document.getElementById("pendentes-total").textContent = contatos.length;

      const dataAtual = new Date().toLocaleDateString();
      const totalHoje = contatosFeitos.filter((c) => c.dataHora.startsWith(dataAtual)).length;
      document.getElementById("contador-dia").textContent = totalHoje;
      document.getElementById("contador-historico").textContent = contatosFeitos.length;
    }

    function limparFiltros() {
      document.getElementById("filtroNome").value = "";
      document.getElementById("filtroLead").value = "";
      document.getElementById("filtroStatus").value = "";
      aplicarFiltrosGlobais();
    }

    function aplicarFiltrosGlobais() {
      renderizarContatos();
      atualizarContatosFeitos();
    }

    function resetGeral() {
      if (confirm("Apagar lista e hist√≥rico?")) {
        contatos = [];
        contatosFeitos = [];
        localStorage.removeItem(STORAGE_PENDENTES);
        localStorage.removeItem(STORAGE_FEITOS);
        document.getElementById("lista-contatos").innerHTML = "";
        atualizarContatosFeitos();
        atualizarVisoes();
      }
    }

    renderizarContatos();
    atualizarContatosFeitos();
    atualizarVisoes();
  </script>
</body>
</html>

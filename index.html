<!-- v2025-06-25-17h40 | Importação CSV + XLSX (SheetJS) + Layout preservado -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discador WM</title>
  <style>
    :root {
      --primary: #004aad;
      --secondary: #2ecc71;
      --danger: #e74c3c;
      --bg: #f7f7f7;
    }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: var(--bg); }
    header { display: flex; align-items: center; gap: 10px; }
    header img { height: 40px; }
    h1 { font-size: 20px; color: var(--primary); }
    input[type="file"] { margin-top: 10px; }
    button { margin: 5px; padding: 8px 14px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }
    .btn-call { background: var(--secondary); color: white; }
    .btn-whatsapp { background: green; color: white; }
    .btn-clear { background: #ccc; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: var(--primary); color: white; }
    .msg { margin-top: 10px; padding: 8px; border-radius: 6px; display: none; }
    .msg.ok { background: #e8fce8; color: #070; }
    .msg.error { background: #fee; color: #900; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <img src="logo.png" alt="WM Logo">
    <h1>Discador Automático WM</h1>
  </header>

  <input type="file" id="fileInput" accept=".csv,.xlsx">
  <button class="btn-clear" onclick="clearData()">Limpar Dados</button>
  <div id="msg" class="msg"></div>

  <h2>Contatos</h2>
  <table id="contatoTable">
    <thead><tr><th>Nome</th><th>Número</th><th>Ação</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Histórico</h2>
  <table id="historicoTable">
    <thead><tr><th>Nome</th><th>Número</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const KEY_CONTATOS = 'wm_contatos';
    const KEY_HISTORICO = 'wm_historico';

    const msgBox = document.getElementById('msg');
    function showMsg(text, ok=true) {
      msgBox.textContent = text;
      msgBox.className = 'msg ' + (ok ? 'ok' : 'error');
      msgBox.style.display = 'block';
      setTimeout(() => msgBox.style.display = 'none', 7000);
    }

    const salvarLocal = (k, d) => localStorage.setItem(k, JSON.stringify(d));
    const carregarLocal = k => JSON.parse(localStorage.getItem(k) || '[]');

    function render() {
      const contatos = carregarLocal(KEY_CONTATOS);
      const historico = carregarLocal(KEY_HISTORICO);
      const tbody = document.querySelector('#contatoTable tbody');
      const histbody = document.querySelector('#historicoTable tbody');
      tbody.innerHTML = histbody.innerHTML = '';
      contatos.forEach((c, i) => {
        tbody.insertAdjacentHTML('beforeend', `<tr><td>${c.nome}</td><td>${c.numero}</td><td><button class="btn-call" onclick="ligar(${i})">Ligar</button><button class="btn-whatsapp" onclick="abrirWhatsApp('${c.numero}')">Whats</button></td></tr>`);
      });
      historico.forEach(h => {
        histbody.insertAdjacentHTML('beforeend', `<tr><td>${h.nome}</td><td>${h.numero}</td><td>${h.status}</td></tr>`);
      });
    }

    function ligar(i) {
      const cont = carregarLocal(KEY_CONTATOS);
      const hist = carregarLocal(KEY_HISTORICO);
      const c = cont.splice(i,1)[0];
      hist.unshift({ ...c, status:'Ligado' });
      salvarLocal(KEY_CONTATOS, cont);
      salvarLocal(KEY_HISTORICO, hist);
      render();
    }
    const abrirWhatsApp = num => window.open(`https://wa.me/55${num}`, '_blank');
    const clearData = () => {
      if(confirm('Apagar todos os dados?')) { localStorage.clear(); render(); showMsg('Dados apagados', true);} }

    document.getElementById('fileInput').addEventListener('change', function(){
      const file = this.files[0]; if(!file) return;
      const ext = file.name.split('.').pop().toLowerCase();
      if(ext==='csv') importCSV(file); else if(ext==='xlsx') importXLSX(file); else showMsg('Formato não suportado', false);
    });

    function importCSV(file){
      Papa.parse(file,{header:false,skipEmptyLines:'greedy',complete:res=>processRows(res.data)});
    }
    function importXLSX(file){
      const reader = new FileReader();
      reader.onload = e=>{
        const wb = XLSX.read(e.target.result,{type:'binary'});
        const firstSheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet,{header:1,defval:''});
        processRows(rows);
      };
      reader.readAsBinaryString(file);
    }

    function processRows(rows){
      try{
        const newContacts = [];
        rows.forEach(r=>{
          if(r.length<2) return;
          let nome=(r[0]||'').toString().trim();
          let numero=(r[1]||'').toString().replace(/\D/g,'');
          if(!nome||!numero) return;
          newContacts.push({nome,numero});
        });
        if(!newContacts.length) {showMsg('Nenhum contato válido',false);return;}
        const atual = carregarLocal(KEY_CONTATOS);
        const numeros = new Set(atual.map(c=>c.numero));
        const unicos = newContacts.filter(c=>!numeros.has(c.numero));
        salvarLocal(KEY_CONTATOS,[...atual,...unicos]);
        showMsg(`${unicos.length} contato(s) importado(s)`,true);
        render();
      }catch(err){console.error(err);showMsg('Erro ao importar',false);} }

    window.addEventListener('DOMContentLoaded', render);
  </script>
</body>
</html>

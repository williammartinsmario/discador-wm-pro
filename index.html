<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wm Discador</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0d6efd;
      --danger: #dc3545;
      --success: #25d366;
      --warning: #ff9800;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #f4f6fb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: #0f172a;
      padding-bottom: 80px;
    }

    a { color: inherit; text-decoration: none; }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

    header {
      background: #fff;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0;
    }

    .logo-box { display: flex; align-items: center; gap: 14px; }
    .logo-box img { height: 56px; }
    .logo-box h1 { font-size: 24px; font-weight: 700; color: #003366; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      background: #f8fafc;
      color: #0f172a;
      white-space: nowrap;
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(0,0,0,0.07); }
    .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .btn-success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn-warning { background: var(--warning); color: #fff; border-color: var(--warning); }
    .btn-ghost { background: #f1f5f9; color: #0f172a; border-color: var(--border); }

    #top-bar {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 18px 0 12px;
      display: grid;
      gap: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.06);
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .top-row textarea,
    .top-row input[type="text"],
    .top-row select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: #f8fafc;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .top-row textarea:focus,
    .top-row input[type="text"]:focus,
    .top-row select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13,110,253,0.15); }

    #textoContatos { min-width: 280px; min-height: 42px; resize: vertical; flex: 1 1 260px; }
    #filtroNome { min-width: 190px; }
    #filtroLead { min-width: 150px; }

    .toolbar-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-left: auto; }

    .stats-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-bottom: 10px;
    }

    .stat-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.04);
    }

    .stat-card h3 { font-size: 14px; color: #475569; margin-bottom: 8px; font-weight: 600; }
    .stat-card .value { font-size: 26px; font-weight: 700; color: #0f172a; }

    #contador { font-weight: 600; color: #003366; margin: 12px 0; }

    .contato-card {
      background: #fff;
      margin: 14px 0;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 22px rgba(0,0,0,0.05);
      padding: 16px 18px;
    }

    .contato-top {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .contato-top span.nome { font-weight: 700; min-width: 200px; font-size: 15px; }
    .contato-top span.numero { color: #475569; font-weight: 600; }

    .formulario { margin-top: 8px; display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .formulario textarea { grid-column: 1 / -1; min-height: 64px; resize: vertical; }
    .formulario select, .formulario textarea { border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-size: 14px; }

    h2.section { margin: 28px 0 10px; font-size: 20px; color: #003366; }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 22px rgba(0,0,0,0.05); }
    thead { background: #003366; color: #fff; }
    th, td { padding: 10px 12px; border: 1px solid var(--border); font-size: 14px; text-align: left; }
    tbody tr:nth-child(even) { background: #f8fafc; }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 14px;
      background: #003366;
      color: #fff;
      text-align: center;
      font-size: 13px;
    }

    @media (max-width: 768px) {
      .toolbar-actions { width: 100%; justify-content: flex-start; }
      .formulario { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <div class="logo-box">
        <img src="logo.png" alt="WM Logo">
        <h1>Wm Discador</h1>
      </div>
      <button class="btn btn-ghost" onclick="resetGeral()">üîÑ Reset Geral</button>
    </div>
  </header>

  <main class="container">
    <section id="top-bar">
      <div class="top-row">
        <input type="file" id="fileInput" accept=".csv">
        <textarea id="textoContatos" rows="2" placeholder="Cole aqui: Nome,Numero"></textarea>
        <button class="btn btn-ghost" onclick="importarTexto()">üì• Adicionar colagem</button>
        <input type="text" id="filtroNome" placeholder="üîç Filtrar nome">
        <select id="filtroLead">
          <option value="">Todos os leads</option>
          <option value="Quente">üî• Quente</option>
          <option value="Frio">‚ùÑÔ∏è Frio</option>
          <option value="Aguardando">‚è≥ Aguardando</option>
        </select>
        <div class="toolbar-actions">
          <button class="btn btn-ghost" onclick="limparFiltros()">üßπ Limpar Filtros</button>
          <button class="btn btn-primary" onclick="exportarPendentes()">üíæ Backup pendentes</button>
          <button class="btn btn-primary" onclick="exportarCSV()">üíæ Backup hist√≥rico</button>
        </div>
      </div>
    </section>

    <section class="stats-grid">
      <div class="stat-card">
        <h3>Pendentes para discar</h3>
        <div class="value" id="statPendentes">0</div>
      </div>
      <div class="stat-card">
        <h3>Liga√ß√µes feitas hoje</h3>
        <div class="value" id="statHoje">0</div>
      </div>
      <div class="stat-card">
        <h3>Total no hist√≥rico</h3>
        <div class="value" id="statHistorico">0</div>
      </div>
    </section>

    <p id="contador">üìä Liga√ß√µes feitas hoje: 0</p>
    <div id="lista-contatos"></div>

    <h2 class="section">üìú Hist√≥rico de Liga√ß√µes</h2>
    <table id="contatos-feitos">
      <thead>
        <tr><th>Nome</th><th>N√∫mero</th><th>Status</th><th>Informa√ß√µes</th><th>Lead</th><th>Data/Hora</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>¬© 2025 WM Assessoria ‚Äì Todos os direitos reservados.</footer>

  <script>
    let contatos = [];
    let contatosFeitos = [];
    let db;
    const HISTORICO_LOCAL_KEY = "contatosFeitos";
    const DB_NAME = "DiscadorDB";
    const DB_VERSION = 2;

    document.getElementById("fileInput").addEventListener("change", importarCSV);
    document.getElementById("filtroNome").addEventListener("input", renderizarContatos);
    document.getElementById("filtroLead").addEventListener("change", renderizarContatos);

    function normalizarNumero(numeroEntrada) {
      let numero = (numeroEntrada || "").replace(/\D/g, "");

      if (numero.startsWith("55") && numero.length > 11) {
        numero = numero.slice(2);
      }

      if (numero.length === 8) {
        numero = "9" + numero;
      }

      if (numero.length < 10 || numero.length > 11) {
        return { numero: "" };
      }

      return { numero };
    }

    function abrirBanco() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = e => {
          const database = e.target.result;
          if (!database.objectStoreNames.contains("contatos")) {
            const store = database.createObjectStore("contatos", { keyPath: "numero" });
            store.createIndex("numero", "numero", { unique: true });
          }
          if (!database.objectStoreNames.contains("historico")) {
            database.createObjectStore("historico", { keyPath: "id", autoIncrement: true });
          }
        };

        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = () => reject(request.error || new Error("Erro ao abrir banco"));
      });
    }

    function aguardarTransacao(tx) {
      return new Promise((resolve, reject) => {
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
        tx.onabort = () => reject(tx.error);
      });
    }

    async function carregarContatosPendentes() {
      if (!db) return [];
      return new Promise((resolve, reject) => {
        const tx = db.transaction("contatos", "readonly");
        const store = tx.objectStore("contatos");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    async function substituirContatosPendentes(lista) {
      if (!db) return;
      const tx = db.transaction("contatos", "readwrite");
      const store = tx.objectStore("contatos");
      store.clear();
      lista.forEach(c => store.put(c));
      return aguardarTransacao(tx);
    }

    async function removerContatoPendente(numero) {
      if (!db) return;
      const tx = db.transaction("contatos", "readwrite");
      tx.objectStore("contatos").delete(numero);
      return aguardarTransacao(tx);
    }

    async function carregarHistorico() {
      if (!db) return [];
      return new Promise((resolve, reject) => {
        const tx = db.transaction("historico", "readonly");
        const store = tx.objectStore("historico");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    async function salvarHistorico(registro) {
      if (!db) return;
      const tx = db.transaction("historico", "readwrite");
      tx.objectStore("historico").add(registro);
      return aguardarTransacao(tx);
    }

    async function sobrescreverHistorico(lista) {
      if (!db) return;
      const tx = db.transaction("historico", "readwrite");
      const store = tx.objectStore("historico");
      store.clear();
      lista.forEach(item => store.put(item));
      return aguardarTransacao(tx);
    }

    async function limparBanco() {
      if (!db) return;
      const tx = db.transaction(["contatos", "historico"], "readwrite");
      tx.objectStore("contatos").clear();
      tx.objectStore("historico").clear();
      return aguardarTransacao(tx);
    }

    function atualizarLocalHistorico() {
      localStorage.setItem(HISTORICO_LOCAL_KEY, JSON.stringify(contatosFeitos));
    }

    async function importarCSV(e) {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = async ev => {
        const linhas = ev.target.result.split(/\r?\n/).slice(1);
        let adicionados = 0; let ignorados = 0; let duplicados = 0;

        linhas.forEach(l => {
          if (!l.trim()) return;
          const [nome, numeroRaw] = l.split(",");
          const { numero } = normalizarNumero(numeroRaw?.trim() || "");
          if (!numero) { ignorados++; return; }
          if (contatos.some(c => c.numero === numero)) { duplicados++; return; }
          contatos.push({ nome: (nome || "Sem nome").trim() || "Sem nome", numero, lead: "Aguardando" });
          adicionados++;
        });

        await substituirContatosPendentes(contatos);
        renderizarContatos();
        atualizarContador();
        alert(`Importa√ß√£o conclu√≠da: ${adicionados} adicionados, ${duplicados} duplicados ignorados, ${ignorados} inv√°lidos.`);
      };
      r.readAsText(f);
    }

    async function importarTexto() {
      const texto = document.getElementById("textoContatos").value || "";
      const linhas = texto.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      let adicionados = 0; let ignorados = 0; let duplicados = 0;

      linhas.forEach(linha => {
        const partes = linha.split(",");
        const nome = partes.length > 1 ? partes[0].trim() : "";
        const numeroRaw = partes.length > 1 ? partes.slice(1).join(",").trim() : partes[0].trim();
        const { numero } = normalizarNumero(numeroRaw);
        if (!numero) { ignorados++; return; }
        if (contatos.some(c => c.numero === numero)) { duplicados++; return; }
        contatos.push({ nome: nome || "Sem nome", numero, lead: "Aguardando" });
        adicionados++;
      });

      if (!adicionados) return alert("Nenhum contato v√°lido encontrado.");
      await substituirContatosPendentes(contatos);
      renderizarContatos();
      atualizarContador();
      alert(`Importa√ß√£o conclu√≠da: ${adicionados} adicionados, ${duplicados} duplicados ignorados, ${ignorados} inv√°lidos.`);
    }

    function renderizarContatos() {
      const lista = document.getElementById("lista-contatos");
      lista.innerHTML = "";
      const filNome = document.getElementById("filtroNome").value.toLowerCase();
      const filLead = document.getElementById("filtroLead").value;

      contatos.forEach(c => {
        if (filNome && !c.nome.toLowerCase().includes(filNome)) return;
        if (filLead && c.lead !== filLead) return;

        const card = document.createElement("div");
        card.className = "contato-card";

        const top = document.createElement("div");
        top.className = "contato-top";
        const spanNome = document.createElement("span");
        spanNome.className = "nome";
        spanNome.textContent = c.nome;
        const spanNumero = document.createElement("span");
        spanNumero.className = "numero";
        spanNumero.textContent = c.numero;
        top.append(spanNome, spanNumero);

        const ligar = criarBtn("üìû Ligar", "btn btn-danger", () => window.location.href = `tel:+55${c.numero}`);
        const whats = criarBtn("üí¨ WhatsApp", "btn btn-success", () => window.open(`https://wa.me/55${c.numero}`, "_blank"));
        top.append(ligar, whats);

        card.appendChild(top);

        const form = document.createElement("div");
        form.className = "formulario";
        const status = select(["Atendeu", "Caixa", "N√£o Atendeu", "Desligou", "Sem Resposta"]);
        const info = document.createElement("textarea");
        info.placeholder = "Informa√ß√µes adicionais";
        const lead = select(["Quente", "Frio", "Aguardando"]);
        lead.value = c.lead || "Aguardando";
        const salvar = criarBtn("üíæ Salvar", "btn btn-warning", async () => {
          if (!confirm("Salvar no hist√≥rico?")) return;
          const dataHora = new Date().toLocaleString();
          const registro = { nome: c.nome, numero: c.numero, status: status.value, info: info.value, lead: lead.value, dataHora };
          contatosFeitos.push(registro);
          atualizarLocalHistorico();
          await salvarHistorico(registro);
          const indiceAtual = contatos.findIndex(item => item.numero === c.numero);
          if (indiceAtual >= 0) contatos.splice(indiceAtual, 1);
          await substituirContatosPendentes(contatos);
          renderizarContatos();
          atualizarContatosFeitos();
          atualizarContador();
        });

        form.append(status, info, lead, salvar);
        card.appendChild(form);
        lista.appendChild(card);
      });
    }

    function criarBtn(txt, cls, fn) {
      const b = document.createElement("button");
      b.textContent = txt;
      b.className = cls;
      b.onclick = fn;
      return b;
    }

    function select(opts) {
      const s = document.createElement("select");
      opts.forEach(o => {
        const op = document.createElement("option");
        op.text = o; op.value = o;
        s.appendChild(op);
      });
      return s;
    }

    function atualizarContatosFeitos() {
      const tb = document.querySelector("#contatos-feitos tbody");
      tb.innerHTML = "";
      contatosFeitos.forEach(c => {
        const tr = document.createElement("tr");
        const campos = [c.nome, c.numero, c.status, c.info, c.lead, c.dataHora];
        campos.forEach(valor => {
          const td = document.createElement("td");
          td.textContent = valor;
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
    }

    function exportarCSV() {
      const csv = "Nome,N√∫mero,Status,Informa√ß√µes,Lead,DataHora\n" + contatosFeitos.map(c => [c.nome, c.numero, c.status, c.info, c.lead, c.dataHora].join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "contatos_feitos.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportarPendentes() {
      const csv = "Nome,N√∫mero,Lead\n" + contatos.map(c => [c.nome, c.numero, c.lead || "Aguardando"].join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "contatos_pendentes.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function atualizarContador() {
      const d = new Date().toLocaleDateString();
      const totalHoje = contatosFeitos.filter(c => c.dataHora && c.dataHora.startsWith(d)).length;
      const contador = document.getElementById("contador");
      if (contador) contador.textContent = "üìä Liga√ß√µes feitas hoje: " + totalHoje;
      const statPendentes = document.getElementById("statPendentes");
      if (statPendentes) statPendentes.textContent = contatos.length;
      const statHoje = document.getElementById("statHoje");
      if (statHoje) statHoje.textContent = totalHoje;
      const statHistorico = document.getElementById("statHistorico");
      if (statHistorico) statHistorico.textContent = contatosFeitos.length;
    }

    function limparFiltros() {
      document.getElementById("filtroNome").value = "";
      document.getElementById("filtroLead").value = "";
      renderizarContatos();
    }

    async function resetGeral() {
      if (confirm("Apagar lista e hist√≥rico?")) {
        contatos = []; contatosFeitos = [];
        atualizarLocalHistorico();
        document.getElementById("lista-contatos").innerHTML = "";
        await limparBanco();
        atualizarContatosFeitos();
        atualizarContador();
        localStorage.removeItem(HISTORICO_LOCAL_KEY);
      }
    }

    async function inicializarApp() {
      try {
        await abrirBanco();
        contatos = await carregarContatosPendentes();
        contatosFeitos = await carregarHistorico();

        if (!contatosFeitos.length) {
          const local = JSON.parse(localStorage.getItem(HISTORICO_LOCAL_KEY)) || [];
          if (local.length) {
            contatosFeitos = local;
            await sobrescreverHistorico(local);
          }
        } else {
          atualizarLocalHistorico();
        }

        renderizarContatos();
        atualizarContatosFeitos();
        atualizarContador();
      } catch (err) {
        console.error("Erro ao inicializar banco IndexedDB", err);
        contatosFeitos = JSON.parse(localStorage.getItem(HISTORICO_LOCAL_KEY)) || [];
        atualizarContatosFeitos();
        atualizarContador();
      }
    }

    inicializarApp();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discador WM</title>
  <style>
    :root {
      --primary: #004aad;      /* azul WM */
      --secondary: #2ecc71;    /* verde WhatsApp */
      --danger: #e74c3c;       /* vermelho ação */
      --bg: #f7f7f7;
    }
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { margin: 0; padding: 20px; background: var(--bg); }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    header img { height: 48px; }
    h1 { font-size: 1.5rem; margin: 0; color: var(--primary); }

    .panel { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .panel + .panel { margin-top: 24px; }

    input[type="file"] { margin-bottom: 12px; }
    button {
      border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;
      font-weight: 600; transition: background .2s;
    }
    .btn-clear { background: #ccc; }
    .btn-clear:hover { background: #b5b5b5; }
    .btn-call { background: var(--secondary); color: #fff; }
    .btn-call:active { background: var(--danger); }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #e0e0e0; padding: 8px; text-align: left; font-size: 0.9rem; }
    th { background: var(--primary); color: #fff; }
    tbody tr:nth-child(odd) { background: #fafafa; }

    .msg { padding: 8px 12px; border-radius: 6px; margin-top: 12px; display: none; }
    .msg.error { background: #fee; color: #900; }
    .msg.ok    { background: #e8fce8; color: #070; }

    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 15px; }
      td { border: none; position: relative; padding-left: 50%; }
      td::before { position: absolute; left: 0; top: 0; width: 45%; padding-left: 10px; font-weight: 600; white-space: nowrap; }
      td:nth-of-type(1)::before { content: "Nome"; }
      td:nth-of-type(2)::before { content: "Número"; }
      td:nth-of-type(3)::before { content: "Ação"; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="WM Logo" />
    <h1>Importar Contatos</h1>
  </header>

  <section class="panel">
    <input type="file" id="fileInput" accept=".csv" />
    <button class="btn-clear" id="clearData">Limpar dados</button>
    <div id="msg" class="msg"></div>

    <h2>Lista de Contatos</h2>
    <table id="contactTable">
      <thead>
        <tr><th>Nome</th><th>Número</th><th>Ação</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="panel">
    <h2>Histórico</h2>
    <table id="historyTable">
      <thead>
        <tr><th>Nome</th><th>Número</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
  const CONTACTS_KEY = 'wm_contacts';
  const HISTORY_KEY  = 'wm_history';

  const load = key => JSON.parse(localStorage.getItem(key) || '[]');
  const save = (key, data) => localStorage.setItem(key, JSON.stringify(data));

  const msgBox = document.getElementById('msg');
  function showMsg(text, ok=true) {
    msgBox.textContent = text;
    msgBox.className = 'msg ' + (ok ? 'ok' : 'error');
    msgBox.style.display = 'block';
    setTimeout(()=>msgBox.style.display='none', 5000);
  }

  function render() {
    const contacts = load(CONTACTS_KEY);
    const history  = load(HISTORY_KEY);

    const tbody = document.querySelector('#contactTable tbody');
    const hbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';
    hbody.innerHTML = '';

    contacts.forEach((c, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `\n        <td>${c.nome}</td>\n        <td><a href="tel:${c.numero}">${c.numero}</a></td>\n        <td><button class="btn-call" data-idx="${idx}">Ligar</button></td>`;
      tbody.appendChild(tr);
    });

    history.forEach(h => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${h.nome}</td><td>${h.numero}</td><td>${h.status}</td>`;
      hbody.appendChild(tr);
    });

    document.querySelectorAll('.btn-call').forEach(btn => {
      btn.addEventListener('click', e => handleCall(e.target.dataset.idx));
    });
  }

  function handleCall(index) {
    const contacts = load(CONTACTS_KEY);
    const history  = load(HISTORY_KEY);

    const contato  = contacts.splice(index, 1)[0];
    history.unshift({ ...contato, status: 'Ligado' });

    save(CONTACTS_KEY, contacts);
    save(HISTORY_KEY, history);
    render();
  }

  function parseCSV(text) {
    const linhas = text.trim().split(/\r?\n/);
    const contatos = [];
    linhas.forEach((raw,i)=>{
      if(!raw.trim()) return; // pula linha vazia
      const delim = raw.includes(';') ? ';' : ',';
      const parts = raw.split(delim);
      if(parts.length < 2) return; // ignora se não tiver 2 colunas
      let nome = parts[0].replace(/"/g,'').trim();
      let numero = parts[1].replace(/"/g,'').trim();
      if(!nome || !numero) return;
      contatos.push({ nome, numero });
    });
    return contatos;
  }

  document.getElementById('fileInput').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
      showMsg('Por favor, selecione um arquivo .csv válido.', false);
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const novos = parseCSV(e.target.result);
        if (novos.length === 0) {
          showMsg('Nenhum contato válido encontrado no arquivo.', false);
          return;
        }
        const contatosAtuais = load(CONTACTS_KEY);
        const numerosAtuais = new Set(contatosAtuais.map(c => c.numero));
        const unicos = novos.filter(c => !numerosAtuais.has(c.numero));
        save(CONTACTS_KEY, [...contatosAtuais, ...unicos]);
        render();
        showMsg(`${unicos.length} novo(s) contato(s) adicionado(s).`, true);
      } catch(err) {
        console.error(err);
        showMsg('Erro ao ler o arquivo. Verifique o formato.', false);
      }
    };
    reader.readAsText(file, 'UTF-8');
  });

  document.getElementById('clearData').addEventListener('click', () => {
    if (confirm('Tem certeza? Isso apagará todos os dados.')) {
      localStorage.clear();
      render();
      showMsg('Dados apagados.', true);
    }
  });

  window.addEventListener('DOMContentLoaded', render);
  </script>
</body>
</html>

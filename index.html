<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wm Discador</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Poppins',sans-serif;
    background:#f4f6f9;
    color:#333;
    padding-bottom:80px;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 32px;background:#fff;border-bottom:2px solid #e5e7eb;
  }
  .logo-box{display:flex;align-items:center;gap:16px}
  .logo-box img{height:60px}
  header h1{font-size:26px;color:#003366;font-weight:600}
  #top-bar{
    display:flex;flex-wrap:wrap;align-items:center;gap:12px;
    padding:16px 32px;background:#fafafa;border-bottom:1px solid #ddd;
  }
  button{
    display:inline-flex;align-items:center;gap:6px;
    padding:10px 18px;border:none;border-radius:8px;font-weight:600;
    font-size:14px;cursor:pointer;transition:.25s;white-space:nowrap;
  }
  button:hover{opacity:.9;transform:translateY(-2px)}
  .btn-ligar{background:#dc3545;color:#fff}
  .btn-whats{background:#25D366;color:#fff}
  .btn-salvar{background:#ff9800;color:#fff}
  .btn-backup{background:#007bff;color:#fff}
  .btn-reset{background:#6c757d;color:#fff}
  .btn-drive{background:#4caf50;color:#fff}
  .btn-acoes{background:#f1f3f5;color:#333}
  input[type="text"],select{
    padding:9px 12px;border:1px solid #ccc;border-radius:8px;font-size:14px
  }
  #drive-status{
    font-weight:600;
    color:#0f5132;
    background:#d1e7dd;
    padding:8px 12px;
    border-radius:8px;
  }
  #contador{padding:16px 32px;font-weight:600;color:#444}
  .contato-card{
    background:#fff;margin:16px 32px;border-radius:10px;
    box-shadow:0 1px 4px rgba(0,0,0,.08);padding:18px 22px
  }
  .contato-top{
    display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:10px
  }
  .contato-top span.nome{font-weight:600;min-width:230px}
  .contato-top span.numero{color:#555}
  .formulario{margin-top:10px;display:grid;gap:8px}
  .formulario select,.formulario textarea{border:1px solid #ccc;border-radius:8px;font-size:14px;padding:8px}
  textarea{min-height:60px;resize:vertical}
  h2.section{margin:32px 32px 8px;font-size:22px;color:#003366}
  table{width:calc(100% - 64px);margin:0 32px 32px;border-collapse:collapse}
  thead{background:#003366;color:#fff}
  th,td{padding:10px;border:1px solid #d1d5db;font-size:14px;text-align:left}
  tbody tr:nth-child(even){background:#f9fafb}
  footer{
    position:fixed;bottom:0;width:100%;padding:14px;
    background:#003366;color:#fff;text-align:center;font-size:13px
  }
  </style>
</head>
<body>

<header>
  <div class="logo-box">
    <img src="logo.png" alt="WM Logo">
    <h1>Wm Discador</h1>
  </div>
  <button class="btn-reset" onclick="resetGeral()">üîÑ Reset Geral</button>
</header>

<div id="top-bar">
  <input type="file" id="fileInput" accept=".csv">
  <input type="text" id="filtroNome" placeholder="üîç Filtrar nome">
  <select id="filtroLead">
    <option value="">Todos os leads</option>
    <option value="Quente">üî• Quente</option>
    <option value="Frio">‚ùÑÔ∏è Frio</option>
    <option value="Aguardando">‚è≥ Aguardando</option>
  </select>
  <button class="btn-acoes" onclick="limparFiltros()">üßπ Limpar Filtros</button>
  <button class="btn-backup" onclick="exportarCSV()">üíæ Backup</button>
  <button class="btn-drive" id="btnDrive" onclick="solicitarConexaoDrive()">üîó Conectar ao Drive</button>
  <span id="drive-status" aria-live="polite">Drive n√£o conectado</span>
</div>

<p id="contador">üìä Liga√ß√µes feitas hoje: 0</p>
<div id="lista-contatos"></div>

<h2 class="section">üìú Hist√≥rico de Liga√ß√µes</h2>
<table id="contatos-feitos">
  <thead><tr><th>Nome</th><th>N√∫mero</th><th>Status</th><th>Informa√ß√µes</th><th>Lead</th><th>Data/Hora</th></tr></thead>
  <tbody></tbody>
</table>

<footer>¬© 2025 WM Assessoria ‚Äì Todos os direitos reservados.</footer>

<script>
let contatos=[];let contatosFeitos=JSON.parse(localStorage.getItem("contatosFeitos"))||[];
const DRIVE_SCOPES="https://www.googleapis.com/auth/drive.file";
let driveFileId=localStorage.getItem("driveFileId")||"";
let tokenClient=null;
let bibliotecasCarregadas=false;
let driveAutenticado=false;
const driveConfig=JSON.parse(localStorage.getItem("driveConfig"))||{clientId:"",apiKey:""};
document.getElementById("fileInput").addEventListener("change",importarCSV);
document.getElementById("filtroNome").addEventListener("input",renderizarContatos);
document.getElementById("filtroLead").addEventListener("change",renderizarContatos);

function importarCSV(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const linhas=ev.target.result.split(/\r?\n/).slice(1);
    contatos=linhas.map(l=>{
      const[nome,numeroRaw]=l.split(",");
      let numero=numeroRaw?.trim()||"";

      // üîπ Normaliza removendo tudo que n√£o for d√≠gito
      numero=numero.replace(/\D/g,"");

      // üîπ Corrige n√∫mero (acrescenta 9 se faltar)
      if(numero.length>=10){
        const ddd=numero.slice(0,2);   // primeiros 2 d√≠gitos
        let celular=numero.slice(2);   // resto
        if(celular.length===8){        // se s√≥ tem 8 d√≠gitos
          celular="9"+celular;
        }
        numero=ddd+celular;
      }

      return{nome:nome?.trim(),numero};
    }).filter(c=>c.nome&&c.numero.length>=10);

    renderizarContatos();
    atualizarContador();
  };
  r.readAsText(f);
}

function renderizarContatos(){
  const lista=document.getElementById("lista-contatos");
  lista.innerHTML="";
  const filNome=document.getElementById("filtroNome").value.toLowerCase();
  const filLead=document.getElementById("filtroLead").value;

  contatos.forEach((c,idx)=>{
    if(filNome&&!c.nome.toLowerCase().includes(filNome))return;
    if(filLead&&c.lead!==filLead)return;

    const card=document.createElement("div");
    card.className="contato-card";

    const top=document.createElement("div");
    top.className="contato-top";
    top.innerHTML=`<span class="nome">${c.nome}</span><span class="numero">${c.numero}</span>`;

    const ligar=criarBtn("üìû Ligar","btn-ligar",()=>window.location.href=`tel:+55${c.numero}`);
    const whats=criarBtn("üí¨ WhatsApp","btn-whats",()=>window.open(`https://wa.me/55${c.numero}`,"_blank"));
    top.append(ligar,whats);

    card.appendChild(top);

    const form=document.createElement("div");
    form.className="formulario";
    const status=select(["Atendeu","Caixa","N√£o Atendeu","Desligou","Sem Resposta"]);
    const info=document.createElement("textarea");
    info.placeholder="Informa√ß√µes adicionais";
    const lead=select(["Quente","Frio","Aguardando"]);
    const salvar=criarBtn("üíæ Salvar","btn-salvar",()=>{
      if(!confirm("Salvar no hist√≥rico?"))return;
      const dataHora=new Date().toLocaleString();
      contatosFeitos.push({nome:c.nome,numero:c.numero,status:status.value,info:info.value,lead:lead.value,dataHora});
      localStorage.setItem("contatosFeitos",JSON.stringify(contatosFeitos));
      if(tokenClient) salvarNoDrive();
      atualizarContatosFeitos();
      contatos.splice(idx,1);
      renderizarContatos();
      atualizarContador();
    });

    form.append(status,info,lead,salvar);
    card.appendChild(form);
    lista.appendChild(card);
  });
}

function criarBtn(txt,cls,fn){
  const b=document.createElement("button");
  b.textContent=txt;
  b.className=cls;
  b.onclick=fn;
  return b;
}

function select(opts){
  const s=document.createElement("select");
  opts.forEach(o=>{
    const op=document.createElement("option");
    op.text=o;op.value=o;
    s.appendChild(op);
  });
  return s;
}

function atualizarStatusDrive(texto){
  const el=document.getElementById("drive-status");
  if(el) el.textContent=texto;
}

function atualizarBotaoDrive(texto,{disabled=false}={}){
  const botao=document.getElementById("btnDrive");
  if(!botao) return;
  botao.textContent=texto;
  botao.disabled=disabled;
}

async function carregarBibliotecasGoogle(){
  if(bibliotecasCarregadas) return;
  atualizarStatusDrive("Carregando bibliotecas do Google...");

  await new Promise(resolve=>{
    const script=document.createElement("script");
    script.src="https://apis.google.com/js/api.js";
    script.onload=()=>{
      const gsi=document.createElement("script");
      gsi.src="https://accounts.google.com/gsi/client";
      gsi.onload=resolve;
      document.body.appendChild(gsi);
    };
    document.body.appendChild(script);
  });

  bibliotecasCarregadas=true;
}

async function solicitarConexaoDrive(){
  await carregarBibliotecasGoogle();
  atualizarBotaoDrive("‚è≥ Conectando...",{disabled:true});
  if(!driveConfig.clientId||!driveConfig.apiKey){
    if(!confirm("Para conectar ao Google Drive √© preciso informar o Client ID e a API Key do projeto. Deseja configurar agora?")){
      atualizarStatusDrive("Conex√£o cancelada: credenciais ausentes");
      atualizarBotaoDrive("üîó Conectar ao Drive");
      return;
    }
    const clientIdPrompt=prompt("Informe o Client ID OAuth do Google",driveConfig.clientId||"");
    const apiKeyPrompt=prompt("Informe a API Key do projeto no Google Cloud",driveConfig.apiKey||"");
    driveConfig.clientId=clientIdPrompt?clientIdPrompt.trim():"";
    driveConfig.apiKey=apiKeyPrompt?apiKeyPrompt.trim():"";
    localStorage.setItem("driveConfig",JSON.stringify(driveConfig));
  }

  if(!driveConfig.clientId.trim()||!driveConfig.apiKey.trim()){
    atualizarStatusDrive("Credenciais do Google Drive inv√°lidas");
    atualizarBotaoDrive("üîó Conectar ao Drive");
    return;
  }

  gapi.load("client",async()=>{
    await gapi.client.init({
      apiKey:driveConfig.apiKey,
      discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
    });

    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:driveConfig.clientId,
      scope:DRIVE_SCOPES,
      callback:async(resp)=>{
        if(resp.error){
          atualizarStatusDrive("Erro ao autenticar no Drive");
          atualizarBotaoDrive("üîó Conectar ao Drive");
          return;
        }
        atualizarStatusDrive("Drive conectado. Sincronizando...");
        driveAutenticado=true;
        await sincronizarComDrive();
        atualizarBotaoDrive("‚úÖ Drive conectado",{disabled:true});
      }
    });

    tokenClient.requestAccessToken({prompt:"consent"});
  });
}

async function sincronizarComDrive(){
  try{
    await buscarBackupDrive();
    await salvarNoDrive();
    atualizarStatusDrive("Backup ativo no Drive");
  }catch(e){
    atualizarStatusDrive("Falha ao sincronizar com o Drive");
    atualizarBotaoDrive("üîó Conectar ao Drive");
  }
}

async function assegurarArquivoDrive(){
  if(driveFileId) return driveFileId;
  const criado=await gapi.client.drive.files.create({
    resource:{name:"contatos_feitos.json",mimeType:"application/json"},
    fields:"id"
  });
  driveFileId=criado.result.id;
  localStorage.setItem("driveFileId",driveFileId);
  return driveFileId;
}

async function salvarNoDrive(){
  if(!tokenClient||!driveAutenticado) return;
  await assegurarArquivoDrive();
  try{
    await gapi.client.request({
      path:`/upload/drive/v3/files/${driveFileId}`,
      method:"PATCH",
      params:{uploadType:"media"},
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(contatosFeitos)
    });
  }catch(e){
    atualizarStatusDrive("Erro ao salvar backup no Drive");
    throw e;
  }
}

async function buscarBackupDrive(){
  if(!tokenClient||!driveAutenticado) return;
  if(!driveFileId) return;
  try{
    const resposta=await gapi.client.drive.files.get({fileId:driveFileId,alt:"media"});
    const dadosStr=resposta.body||JSON.stringify(resposta.result||[]);
    const dados=JSON.parse(dadosStr);
    if(Array.isArray(dados)){
      contatosFeitos=dados;
      localStorage.setItem("contatosFeitos",JSON.stringify(contatosFeitos));
      atualizarContatosFeitos();
      atualizarContador();
    }
  }catch(e){
    atualizarStatusDrive("N√£o foi poss√≠vel ler o backup do Drive");
    throw e;
  }
}

function atualizarContatosFeitos(){
  const tb=document.querySelector("#contatos-feitos tbody");
  tb.innerHTML="";
  contatosFeitos.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.nome}</td><td>${c.numero}</td><td>${c.status}</td><td>${c.info}</td><td>${c.lead}</td><td>${c.dataHora}</td>`;
    tb.appendChild(tr);
  });
}

function exportarCSV(){
  const csv="Nome,N√∫mero,Status,Informa√ß√µes,Lead,DataHora\n"+contatosFeitos.map(c=>[c.nome,c.numero,c.status,c.info,c.lead,c.dataHora].join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="contatos_feitos.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

function atualizarContador(){
  const d=new Date().toLocaleDateString();
  const total=contatosFeitos.filter(c=>c.dataHora.startsWith(d)).length;
  document.getElementById("contador").textContent="üìä Liga√ß√µes feitas hoje: "+total;
}

function limparFiltros(){
  document.getElementById("filtroNome").value="";
  document.getElementById("filtroLead").value="";
  renderizarContatos();
}

async function resetGeral(){
  if(confirm("Apagar lista e hist√≥rico?")){
    contatos=[];contatosFeitos=[];
    localStorage.setItem("contatosFeitos",JSON.stringify(contatosFeitos));
    document.getElementById("lista-contatos").innerHTML="";
    if(tokenClient) await salvarNoDrive();
    atualizarContatosFeitos();
    atualizarContador();
  }
}

atualizarContatosFeitos();
atualizarContador();
</script>
</body>
</html>